<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .myCanvas {
        border: 2px solid black;
      }
    </style>
  </head>
  <body>
    <canvas id="myCanvas" width="800" height="500" class="myCanvas"></canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const canvas = document.getElementById("myCanvas");
      const ctx = canvas.getContext("2d");
      const socket = io();
      let worldMap;
      let myPlayer;
      let cameraOffsetX = 0;
      let cameraOffsetY = 0;
      const tileSize = 50;

      socket.on("initGameWorld", (data) => {
        worldMap = data;
      });

      socket.on("newPos", (data) => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        myPlayer = data.playerState.find((p) => p.self);
        if (!myPlayer) return;

        cameraOffsetX = myPlayer.x - canvas.width / 2 + 15;
        cameraOffsetY = myPlayer.y - canvas.height / 2 + 15;

        worldMap.forEach((row, i) => {
          row.forEach((cell, j) => {
            ctx.fillStyle = cell === 1 ? "black" : "green";
            ctx.fillRect(
              i * tileSize - cameraOffsetX,
              j * tileSize - cameraOffsetY,
              tileSize,
              tileSize
            );
          });
        });

        data.playerState.forEach((player) => {
          const screenX = player.x - cameraOffsetX;
          const screenY = player.y - cameraOffsetY;

          ctx.fillStyle = player.self ? "red" : "blue";
          ctx.fillRect(screenX, screenY, 30, 30);
        });
        data.bullets.forEach((bullet) => {
          ctx.fillStyle = "black";
          ctx.fillRect(
            bullet.x - cameraOffsetX,
            bullet.y - cameraOffsetY,
            14,
            14
          );
        });
      });

      document.addEventListener("keydown", (e) => {
        const map = { w: "up", a: "left", s: "down", d: "right" };
        const input = map[e.key.toLowerCase()];
        if (input) socket.emit("keypress", { inputId: input, state: true });
      });

      document.addEventListener("keyup", (e) => {
        const map = { w: "up", a: "left", s: "down", d: "right" };
        const input = map[e.key.toLowerCase()];
        if (input) socket.emit("keypress", { inputId: input, state: false });
      });

      canvas.addEventListener("click", (e) => {
        const rect = canvas.getBoundingClientRect();

        // Canvas coordinates (relative to top-left of canvas)
        const canvasX = e.clientX - rect.left;
        const canvasY = e.clientY - rect.top;

        // Convert to game world coordinates by adding camera offset
        const worldX = canvasX + cameraOffsetX;
        const worldY = canvasY + cameraOffsetY;

        // Now emit the world coordinates of the click
        socket.emit("shoot", { x: worldX, y: worldY, player: myPlayer });
      });
    </script>
  </body>
</html>
